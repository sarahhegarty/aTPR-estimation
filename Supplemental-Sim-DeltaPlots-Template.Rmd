---
title: "sim01-alpha24-1k"
author: "Sarah Hegarty"
date: "Last compiled on `r format(Sys.time(), '%d %B %Y')`"
output: html_document
params:
  simid: '12.05.01'
  simlab: 'sim01-aTPR-alpha24'
  nickname: '1k'
  taulist: 0.2
  sigeps2: 0.1
  h2: 'logit'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, include= FALSE}
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(ggh4x)

folder = paste0('/Users/Sarah/Box/Research/Dissertation/12 Adjusted TPR/numerical/',params$simid,'/simout/')
simlab = paste0(params$simlab,'-',params$nickname)

params
```


# Read in simulation output data
```{r}
# Load Results from fairRisk package
diffs <- NULL
benchN <- NULL
bench1M <- NULL

for(k in 1:60){
  load(paste0(folder,simlab,'_setting_',k,'_with_benchmarks.Rdata'))
  
  settings <- out$settings
  diffs <- diffs %>%
                  bind_rows(out[["df_diffs (refgp = 1)"]] %>%
                              mutate(setting_id = k
                                     ,n1 = settings$n[1]
                                     ,n2 = settings$n[2]
                                     ,alpha1 = settings$alpha[1]
                                     ,alpha2 = settings$alpha[2]
                                     ,beta1 = settings$beta[1]
                                     ,beta2 = settings$beta[2]
                                     ,theta.a1 = settings$theta.a[1]
                                     ,theta.a2 = settings$theta.a[2]
                                     ,theta.b1 = settings$theta.b[1]
                                     ,theta.b2 = settings$theta.b[2]
                                     ,sigeps1 = settings$sigeps[1]
                                     ,sigeps2 = settings$sigeps[2]
                                     ,h1 = settings$h[1]
                                     ,h2 = settings$h[2]
                            )
                    )
  
  benchN <- benchN %>%
                  bind_rows(out[["df_benchN (refgp = 1)"]] %>% 
                              mutate(setting_id = k
                                     ,n1 = settings$n[1]
                                     ,n2 = settings$n[2]
                                     ,alpha1 = settings$alpha[1]
                                     ,alpha2 = settings$alpha[2]
                                     ,beta1 = settings$beta[1]
                                     ,beta2 = settings$beta[2]
                                     ,theta.a1 = settings$theta.a[1]
                                     ,theta.a2 = settings$theta.a[2]
                                     ,theta.b1 = settings$theta.b[1]
                                     ,theta.b2 = settings$theta.b[2]
                                     ,sigeps1 = settings$sigeps[1]
                                     ,sigeps2 = settings$sigeps[2]
                                     ,h1 = settings$h[1]
                                     ,h2 = settings$h[2]
                            ))
  
  bench1M <- bench1M %>%
                  bind_rows(out[["df_bench1M (refgp = 1)"]]  %>%
                              mutate(setting_id = k
                                     ,n1 = settings$n[1]
                                     ,n2 = settings$n[2]
                                     ,alpha1 = settings$alpha[1]
                                     ,alpha2 = settings$alpha[2]
                                     ,beta1 = settings$beta[1]
                                     ,beta2 = settings$beta[2]
                                     ,theta.a1 = settings$theta.a[1]
                                     ,theta.a2 = settings$theta.a[2]
                                     ,theta.b1 = settings$theta.b[1]
                                     ,theta.b2 = settings$theta.b[2]
                                     ,sigeps1 = settings$sigeps[1]
                                     ,sigeps2 = settings$sigeps[2]
                                     ,h1 = settings$h[1]
                                     ,h2 = settings$h[2]
                            )
            )

}

```



# Merge in naive estimates to each row and compute mean and CIs
```{r}
stack.sum <- diffs %>%
            mutate(estimate = if_else(est == 'adjusted','Adjusted','Naive')
                  , nn = if_else(estimate == 'Adjusted', paste0(cal,'+',den),' naive')
            ) %>%
             bind_rows(benchN %>%
                          mutate(estimate = 'Benchmark'
                                 ,nn = ' Benchmark n')
             ) %>%
              group_by(tau, nn, estimate, est, cal ,den
                       , n1, n2, alpha1, alpha2, h1, h2
                       , theta.a1, theta.a2, theta.b1, theta.b2
                       , sigeps1, sigeps2) %>%
              summarize(delta.mean = mean(delta)
                        ,delta.lower = quantile(delta,0.025)
                        ,delta.upper = quantile(delta,0.975)
                        ,delta.se = sd(delta)
                        ,n=n())          
```

# Make Figure 2
```{r}
shortstack <- stack.sum %>%
     filter(est %in% c("adjusted", "naive (np)")) %>%
     filter(tau == params$tau) %>%
     filter(sigeps2 == params$sigeps2, h2 == params$h2) %>%
     rename(b2 = theta.b2
             ,a2 = theta.a2) %>%
     mutate()

shortbench <- bench1M %>%
     filter(est == "naive (np)") %>%
     filter(tau == params$tau) %>%
     filter(sigeps2 == params$sigeps2, h2 == params$h2) %>%
     rename(b2 = theta.b2
             ,a2 = theta.a2) %>%
     mutate(estimate= 'Benchmark'
            ,nn = ' Benchmark 1M') 

ggplot() +
      geom_pointrange(data= shortstack, aes(x=nn, y=delta.mean, ymin=delta.lower, ymax=delta.upper, color=estimate), size = 0.2) +
      geom_hline(yintercept=0, lty=2) +  # add a dotted line at x=1 after flip
      geom_point(data =shortbench,aes(x=nn, y=delta,color=estimate)) + 
      coord_flip() +  # flip coordinates (puts labels on y axis  
      scale_x_discrete() +
      xlab("Estimate Type") +
      ylab(expression(paste("Difference in (a)TPRs, ",Delta))) + 
      facet_grid(a2~ b2, labeller = label_both)+
      theme_bw() + 
      scale_color_manual(name='Estimate Type',values = c('Adjusted' = 'black', 'Naive' = 'maroon', 'Benchmark' = 'deepskyblue')) +
      scale_linetype_manual(name='Estimate Type',values = c('Adjusted' = 'solid', 'Naive' = 'solid', 'Benchmark' = 'solid'))  +
      theme(legend.position="bottom")

ggsave(paste0("supfigs/dTPR-Forest_",simlab,"-",toupper(substr(params$h2,1,1)),params$sigeps*10,".png"),height=6.5,width=6, dpi = 300)
```

